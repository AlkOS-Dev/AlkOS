name: Regression Tests
on: [push, workflow_dispatch]

jobs:
  build_environment:
    name: Build Environment Image
    uses: ./.github/workflows/build_image.yaml

  run_regression_tests:
    name: Run Regression Tests
    needs: build_environment 
    runs-on: ubuntu-latest
    container:
      # Use the specific image built for this commit
      image: ${{ needs.build_environment.outputs.image_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run debug regression tests
        id: debug_tests
        run: "$GITHUB_WORKSPACE/scripts/tests/regression/debug_regression.bash" x86_64 --run
        continue-on-error: true

      - name: Display debug logs on failure
        if: steps.debug_tests.outcome != 'success'
        run: |
          echo "::group::Debug Build Log"
          cat /tmp/alkOS_build.log || echo "Build log not found"
          echo "::endgroup::"
          echo "::group::Debug Regression Log"
          cat /tmp/alkOS_regression.log || echo "Regression log not found"
          echo "::endgroup::"

      - name: Upload debug logs on failure
        if: steps.debug_tests.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: |
            /tmp/alkOS_build.log
            /tmp/alkOS_regression.log
          retention-days: 7

      - name: Run release regression tests
        id: release_tests
        run: "$GITHUB_WORKSPACE/scripts/tests/regression/release_regression.bash" x86_64 --run
        if: always()
        continue-on-error: true

      - name: Display release logs on failure
        if: steps.release_tests.outcome != 'success'
        run: |
          echo "::group::Release Build Log"
          cat /tmp/alkOS_build.log || echo "Build log not found"
          echo "::endgroup::"
          echo "::group::Release Regression Log"
          cat /tmp/alkOS_regression.log || echo "Regression log not found"
          echo "::endgroup::"

      - name: Upload release logs on failure
        if: steps.release_tests.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: release-logs
          path: |
            /tmp/alkOS_build.log
            /tmp/alkOS_regression.log
          retention-days: 7

      - name: Fail workflow if any tests failed
        if: steps.debug_tests.outcome != 'success' || steps.release_tests.outcome != 'success'
        run: exit 1
